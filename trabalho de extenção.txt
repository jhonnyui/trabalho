import { initializeApp } from 'firebase/app';
import { getFirestore } from 'firebase/firestore';
import { getAuth } from 'firebase/auth';
import { getStorage } from 'firebase/storage';
import { getAnalytics } from 'firebase/analytics';

const firebaseConfig = {
  apiKey: "AIzaSyD...",
  authDomain: "frigorifico-vencedor-app.firebaseapp.com",
  projectId: "frigorifico-vencedor-app",
  storageBucket: "frigorifico-vencedor-app.appspot.com",
  messagingSenderId: "123456789",
  appId: "1:123456789:android:abcdef123456",
  measurementId: "G-XXXXXX"
};

// Inicializar Firebase
const app = initializeApp(firebaseConfig);
export const db = getFirestore(app);
export const auth = getAuth(app);
export const storage = getStorage(app);
export const analytics = getAnalytics(app);

// Cole√ß√µes do Firestore
export const COLLECTIONS = {
  PRODUCTS: 'products',
  ORDERS: 'orders',
  CUSTOMERS: 'customers',
  USERS: 'users',
  SETTINGS: 'settings'
};
import React, { createContext, useState, useContext, useEffect } from 'react';
import AsyncStorage from '@react-native-async-storage/async-storage';

const CartContext = createContext();

export const CartProvider = ({ children }) => {
  const [cartItems, setCartItems] = useState([]);
  const [total, setTotal] = useState(0);

  // Carregar carrinho do AsyncStorage
  useEffect(() => {
    loadCart();
  }, []);

  // Salvar carrinho no AsyncStorage
  useEffect(() => {
    saveCart();
    calculateTotal();
  }, [cartItems]);

  const loadCart = async () => {
    try {
      const savedCart = await AsyncStorage.getItem('@cart');
      if (savedCart) {
        setCartItems(JSON.parse(savedCart));
      }
    } catch (error) {
      console.error('Erro ao carregar carrinho:', error);
    }
  };

  const saveCart = async () => {
    try {
      await AsyncStorage.setItem('@cart', JSON.stringify(cartItems));
    } catch (error) {
      console.error('Erro ao salvar carrinho:', error);
    }
  };

  const calculateTotal = () => {
    const total = cartItems.reduce((sum, item) => {
      return sum + (item.price * item.quantity);
    }, 0);
    setTotal(total);
  };

  const addToCart = (product) => {
    setCartItems(prevItems => {
      const existingItem = prevItems.find(item => item.id === product.id);
      
      if (existingItem) {
        return prevItems.map(item =>
          item.id === product.id
            ? { ...item, quantity: item.quantity + 1 }
            : item
        );
      } else {
        return [...prevItems, { ...product, quantity: 1 }];
      }
    });
  };

  const removeFromCart = (productId) => {
    setCartItems(prevItems =>
      prevItems.filter(item => item.id !== productId)
    );
  };

  const updateQuantity = (productId, newQuantity) => {
    if (newQuantity < 1) {
      removeFromCart(productId);
      return;
    }

    setCartItems(prevItems =>
      prevItems.map(item =>
        item.id === productId
          ? { ...item, quantity: newQuantity }
          : item
      )
    );
  };

  const clearCart = () => {
    setCartItems([]);
  };

  const getCartCount = () => {
    return cartItems.reduce((count, item) => count + item.quantity, 0);
  };

  return (
    <CartContext.Provider
      value={{
        cartItems,
        total,
        addToCart,
        removeFromCart,
        updateQuantity,
        clearCart,
        getCartCount
      }}
    >
      {children}
    </CartContext.Provider>
  );
};

export const useCart = () => {
  const context = useContext(CartContext);
  if (!context) {
    throw new Error('useCart deve ser usado dentro de CartProvider');
  }
  return context;
};
import React, { useState, useEffect } from 'react';
import {
  View,
  Text,
  StyleSheet,
  ScrollView,
  TouchableOpacity,
  Image,
  SafeAreaView,
  Alert
} from 'react-native';
import { useNavigation } from '@react-navigation/native';
import Icon from 'react-native-vector-icons/MaterialIcons';
import { collection, query, where, getDocs } from 'firebase/firestore';
import { db } from '../../firebase/config';
import { useCart } from '../context/CartContext';

const HomeScreen = () => {
  const navigation = useNavigation();
  const { getCartCount } = useCart();
  const [featuredProducts, setFeaturedProducts] = useState([]);
  const [promotions, setPromotions] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    loadProducts();
  }, []);

  const loadProducts = async () => {
    try {
      // Buscar produtos em destaque
      const q = query(
        collection(db, 'products'),
        where('featured', '==', true),
        where('available', '==', true)
      );
      
      const querySnapshot = await getDocs(q);
      const products = [];
      querySnapshot.forEach((doc) => {
        products.push({ id: doc.id, ...doc.data() });
      });
      
      setFeaturedProducts(products);

      // Buscar promo√ß√µes
      const promotionsQuery = query(
        collection(db, 'promotions'),
        where('active', '==', true)
      );
      
      const promotionsSnapshot = await getDocs(promotionsQuery);
      const promotionsList = [];
      promotionsSnapshot.forEach((doc) => {
        promotionsList.push({ id: doc.id, ...doc.data() });
      });
      
      setPromotions(promotionsList);
    } catch (error) {
      console.error('Erro ao carregar produtos:', error);
      Alert.alert('Erro', 'N√£o foi poss√≠vel carregar os produtos');
    } finally {
      setLoading(false);
    }
  };

  const navigateToWhatsApp = () => {
    const phoneNumber = '559633338888';
    const message = 'Ol√°! Gostaria de fazer um pedido no Frigor√≠fico Vencedor';
    const url = `whatsapp://send?phone=${phoneNumber}&text=${encodeURIComponent(message)}`;
    
    Linking.openURL(url).catch(() => {
      Alert.alert('Erro', 'WhatsApp n√£o est√° instalado');
    });
  };

  const QuickActionButton = ({ icon, title, onPress, color }) => (
    <TouchableOpacity style={styles.quickAction} onPress={onPress}>
      <View style={[styles.quickActionIcon, { backgroundColor: color }]}>
        <Icon name={icon} size={28} color="#FFF" />
      </View>
      <Text style={styles.quickActionText}>{title}</Text>
    </TouchableOpacity>
  );

  return (
    <SafeAreaView style={styles.container}>
      {/* Header */}
      <View style={styles.header}>
        <View>
          <Text style={styles.greeting}>Bem-vindo ao</Text>
          <Text style={styles.title}>Frigor√≠fico Vencedor</Text>
          <Text style={styles.subtitle}>Santana/AP - Elesb√£o</Text>
        </View>
        <TouchableOpacity 
          style={styles.cartButton}
          onPress={() => navigation.navigate('Cart')}
        >
          <Icon name="shopping-cart" size={24} color="#C62828" />
          {getCartCount() > 0 && (
            <View style={styles.cartBadge}>
              <Text style={styles.cartBadgeText}>{getCartCount()}</Text>
            </View>
          )}
        </TouchableOpacity>
      </View>

      <ScrollView showsVerticalScrollIndicator={false}>
        {/* A√ß√µes r√°pidas */}
        <View style={styles.quickActionsContainer}>
          <QuickActionButton
            icon="store"
            title="Cat√°logo"
            onPress={() => navigation.navigate('Catalog')}
            color="#C62828"
          />
          <QuickActionButton
            icon="whatsapp"
            title="WhatsApp"
            onPress={navigateToWhatsApp}
            color="#25D366"
          />
          <QuickActionButton
            icon="history"
            title="Pedidos"
            onPress={() => navigation.navigate('Orders')}
            color="#FF9800"
          />
          <QuickActionButton
            icon="location-on"
            title="Localiza√ß√£o"
            onPress={() => navigation.navigate('Location')}
            color="#2196F3"
          />
        </View>

        {/* Promo√ß√µes */}
        {promotions.length > 0 && (
          <View style={styles.section}>
            <View style={styles.sectionHeader}>
              <Text style={styles.sectionTitle}>üî• Promo√ß√µes da Semana</Text>
              <TouchableOpacity>
                <Text style={styles.seeAll}>Ver todas</Text>
              </TouchableOpacity>
            </View>
            <ScrollView horizontal showsHorizontalScrollIndicator={false}>
              {promotions.map(promo => (
                <View key={promo.id} style={styles.promoCard}>
                  <View style={styles.promoBadge}>
                    <Text style={styles.promoBadgeText}>-{promo.discount}%</Text>
                  </View>
                  <Image 
                    source={{ uri: promo.image }} 
                    style={styles.promoImage}
                  />
                  <View style={styles.promoInfo}>
                    <Text style={styles.promoTitle}>{promo.title}</Text>
                    <View style={styles.priceContainer}>
                      <Text style={styles.oldPrice}>R$ {promo.oldPrice.toFixed(2)}</Text>
                      <Text style={styles.newPrice}>R$ {promo.newPrice.toFixed(2)}</Text>
                    </View>
                    <Text style={styles.promoValid}>V√°lido at√© {promo.validUntil}</Text>
                  </View>
                </View>
              ))}
            </ScrollView>
          </View>
        )}

        {/* Produtos em destaque */}
        <View style={styles.section}>
          <View style={styles.sectionHeader}>
            <Text style={styles.sectionTitle}>‚≠ê Mais Vendidos</Text>
            <TouchableOpacity onPress={() => navigation.navigate('Catalog')}>
              <Text style={styles.seeAll}>Ver cat√°logo</Text>
            </TouchableOpacity>
          </View>
          <View style={styles.featuredGrid}>
            {featuredProducts.slice(0, 4).map(product => (
              <TouchableOpacity
                key={product.id}
                style={styles.productCard}
                onPress={() => navigation.navigate('ProductDetail', { product })}
              >
                <Image 
                  source={{ uri: product.images[0] }} 
                  style={styles.productImage}
                />
                <View style={styles.productInfo}>
                  <Text style={styles.productName} numberOfLines={1}>
                    {product.name}
                  </Text>
                  <Text style={styles.productCategory}>
                    {product.category}
                  </Text>
                  <Text style={styles.productPrice}>
                    R$ {product.price.toFixed(2)}/{product.unit}
                  </Text>
                  <TouchableOpacity
                    style={styles.addButton}
                    onPress={() => {
                      // Adicionar ao carrinho
                      const { addToCart } = useCart();
                      addToCart(product);
                      Alert.alert('Sucesso', `${product.name} adicionado ao carrinho`);
                    }}
                  >
                    <Text style={styles.addButtonText}>Adicionar</Text>
                  </TouchableOpacity>
                </View>
              </TouchableOpacity>
            ))}
          </View>
        </View>

        {/* Hor√°rio de funcionamento */}
        <View style={styles.hoursCard}>
          <Icon name="access-time" size={24} color="#C62828" />
          <View style={styles.hoursInfo}>
            <Text style={styles.hoursTitle}>Hor√°rio de Funcionamento</Text>
            <Text style={styles.hoursText}>Segunda a Sexta: 7h √†s 18h</Text>
            <Text style={styles.hoursText}>S√°bado: 7h √†s 13h</Text>
            <Text style={styles.hoursNote}>Pedidos via app at√© 22h</Text>
          </View>
        </View>

        {/* Contato r√°pido */}
        <View style={styles.contactCard}>
          <TouchableOpacity 
            style={styles.contactButton}
            onPress={navigateToWhatsApp}
          >
            <Icon name="whatsapp" size={20} color="#FFF" />
            <Text style={styles.contactButtonText}>Falar no WhatsApp</Text>
          </TouchableOpacity>
          <TouchableOpacity 
            style={[styles.contactButton, styles.callButton]}
            onPress={() => Linking.openURL('tel:+559633338888')}
          >
            <Icon name="phone" size={20} color="#FFF" />
            <Text style={styles.contactButtonText}>Ligar Agora</Text>
          </TouchableOpacity>
        </View>
      </ScrollView>
    </SafeAreaView>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#F5F5F5',
  },
  header: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    padding: 20,
    backgroundColor: '#FFF',
    borderBottomWidth: 1,
    borderBottomColor: '#E0E0E0',
  },
  greeting: {
    fontSize: 14,
    color: '#666',
  },
  title: {
    fontSize: 22,
    fontWeight: 'bold',
    color: '#C62828',
  },
  subtitle: {
    fontSize: 12,
    color: '#999',
  },
  cartButton: {
    padding: 10,
    position: 'relative',
  },
  cartBadge: {
    position: 'absolute',
    top: 0,
    right: 0,
    backgroundColor: '#C62828',
    borderRadius: 10,
    minWidth: 20,
    height: 20,
    justifyContent: 'center',
    alignItems: 'center',
  },
  cartBadgeText: {
    color: '#FFF',
    fontSize: 12,
    fontWeight: 'bold',
  },
  quickActionsContainer: {
    flexDirection: 'row',
    justifyContent: 'space-around',
    padding: 20,
    backgroundColor: '#FFF',
    marginTop: 10,
  },
  quickAction: {
    alignItems: 'center',
  },
  quickActionIcon: {
    width: 60,
    height: 60,
    borderRadius: 30,
    justifyContent: 'center',
    alignItems: 'center',
    marginBottom: 8,
  },
  quickActionText: {
    fontSize: 12,
    color: '#333',
    textAlign: 'center',
  },
  section: {
    marginTop: 20,
    paddingHorizontal: 15,
  },
  sectionHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 15,
  },
  sectionTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    color: '#333',
  },
  seeAll: {
    fontSize: 14,
    color: '#C62828',
  },
  promoCard: {
    width: 280,
    backgroundColor: '#FFF',
    borderRadius: 10,
    marginRight: 15,
    overflow: 'hidden',
    elevation: 3,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.1,
    shadowRadius: 4,
  },
  promoBadge: {
    position: 'absolute',
    top: 10,
    left: 10,
    backgroundColor: '#C62828',
    paddingHorizontal: 10,
    paddingVertical: 5,
    borderRadius: 5,
    zIndex: 1,
  },
  promoBadgeText: {
    color: '#FFF',
    fontWeight: 'bold',
    fontSize: 12,
  },
  promoImage: {
    width: '100%',
    height: 120,
    resizeMode: 'cover',
  },
  promoInfo: {
    padding: 15,
  },
  promoTitle: {
    fontSize: 16,
    fontWeight: '600',
    color: '#333',
    marginBottom: 5,
  },
  priceContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: 5,
  },
  oldPrice: {
    fontSize: 14,
    color: '#999',
    textDecorationLine: 'line-through',
    marginRight: 10,
  },
  newPrice: {
    fontSize: 18,
    fontWeight: 'bold',
    color: '#C62828',
  },
  promoValid: {
    fontSize: 12,
    color: '#666',
  },
  featuredGrid: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    justifyContent: 'space-between',
  },
  productCard: {
    width: '48%',
    backgroundColor: '#FFF',
    borderRadius: 10,
    marginBottom: 15,
    overflow: 'hidden',
    elevation: 2,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 1 },
    shadowOpacity: 0.1,
    shadowRadius: 2,
  },
  productImage: {
    width: '100%',
    height: 120,
    resizeMode: 'cover',
  },
  productInfo: {
    padding: 10,
  },
  productName: {
    fontSize: 14,
    fontWeight: '600',
    color: '#333',
    marginBottom: 3,
  },
  productCategory: {
    fontSize: 12,
    color: '#666',
    marginBottom: 5,
  },
  productPrice: {
    fontSize: 16,
    fontWeight: 'bold',
    color: '#C62828',
    marginBottom: 8,
  },
  addButton: {
    backgroundColor: '#C62828',
    paddingVertical: 6,
    borderRadius: 5,
    alignItems: 'center',
  },
  addButtonText: {
    color: '#FFF',
    fontSize: 12,
    fontWeight: '600',
  },
  hoursCard: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#FFF',
    marginHorizontal: 15,
    marginTop: 20,
    padding: 20,
    borderRadius: 10,
    elevation: 2,
  },
  hoursInfo: {
    marginLeft: 15,
    flex: 1,
  },
  hoursTitle: {
    fontSize: 16,
    fontWeight: '600',
    color: '#333',
    marginBottom: 5,
  },
  hoursText: {
    fontSize: 14,
    color: '#666',
    marginBottom: 2,
  },
  hoursNote: {
    fontSize: 12,
    color: '#C62828',
    fontStyle: 'italic',
  },
  contactCard: {
    flexDirection: 'row',
    marginHorizontal: 15,
    marginTop: 15,
    marginBottom: 30,
  },
  contactButton: {
    flex: 1,
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    backgroundColor: '#25D366',
    paddingVertical: 12,
    borderRadius: 8,
    marginRight: 10,
  },
  callButton: {
    backgroundColor: '#C62828',
    marginRight: 0,
    marginLeft: 10,
  },
  contactButtonText: {
    color: '#FFF',
    fontSize: 14,
    fontWeight: '600',
    marginLeft: 8,
  },
});

export default HomeScreen;
import { db, COLLECTIONS } from '../../firebase/config';
import { 
  collection, 
  addDoc, 
  query, 
  where, 
  getDocs, 
  orderBy,
  serverTimestamp,
  updateDoc,
  doc
} from 'firebase/firestore';
import { sendOrderToWhatsApp } from './whatsapp';

export const createOrder = async (orderData) => {
  try {
    // Adicionar metadados do pedido
    const orderWithMetadata = {
      ...orderData,
      status: 'pending',
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp(),
      orderNumber: await generateOrderNumber(),
    };

    // Salvar no Firestore
    const docRef = await addDoc(collection(db, COLLECTIONS.ORDERS), orderWithMetadata);
    
    // Enviar para WhatsApp
    await sendOrderToWhatsApp(orderWithMetadata);
    
    // Atualizar estoque
    await updateStock(orderData.items);
    
    return {
      success: true,
      orderId: docRef.id,
      orderNumber: orderWithMetadata.orderNumber,
      message: 'Pedido criado com sucesso'
    };
  } catch (error) {
    console.error('Erro ao criar pedido:', error);
    throw new Error('Falha ao criar pedido');
  }
};

const generateOrderNumber = async () => {
  const today = new Date();
  const dateStr = today.toISOString().slice(2,10).replace(/-/g, '');
  
  const ordersRef = collection(db, COLLECTIONS.ORDERS);
  const q = query(ordersRef, where('orderNumber', '>=', dateStr + '0000'));
  const snapshot = await getDocs(q);
  
  const sequence = snapshot.size + 1;
  return dateStr + sequence.toString().padStart(4, '0');
};

const updateStock = async (items) => {
  const batch = writeBatch(db);
  
  for (const item of items) {
    const productRef = doc(db, COLLECTIONS.PRODUCTS, item.productId);
    const productDoc = await getDoc(productRef);
    
    if (productDoc.exists()) {
      const currentStock = productDoc.data().stock;
      const newStock = currentStock - item.quantity;
      
      batch.update(productRef, { 
        stock: newStock,
        updatedAt: serverTimestamp()
      });
    }
  }
  
  await batch.commit();
};

export const getUserOrders = async (userId) => {
  try {
    const q = query(
      collection(db, COLLECTIONS.ORDERS),
      where('userId', '==', userId),
      orderBy('createdAt', 'desc')
    );
    
    const querySnapshot = await getDocs(q);
    const orders = [];
    
    querySnapshot.forEach((doc) => {
      orders.push({
        id: doc.id,
        ...doc.data(),
        createdAt: doc.data().createdAt?.toDate() || new Date()
      });
    });
    
    return orders;
  } catch (error) {
    console.error('Erro ao buscar pedidos:', error);
    throw error;
  }
};

export const updateOrderStatus = async (orderId, status) => {
  try {
    const orderRef = doc(db, COLLECTIONS.ORDERS, orderId);
    await updateDoc(orderRef, {
      status,
      updatedAt: serverTimestamp()
    });
    
    return { success: true };
  } catch (error) {
    console.error('Erro ao atualizar status:', error);
    throw error;
  }
};